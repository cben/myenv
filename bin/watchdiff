#!/usr/bin/fish
set old (mktemp --suffix=watchold)
set new (mktemp --suffix=watchnew)

function cleanup --on-signal=SIGINT --on-event fish_exit --on-process-exit %self
    rm -vf $old $new
    exit
end

touch $old
while true
    eval $argv >$new 2>&1
    # Disabled screen clearing, showing all diff history is more useful,
    # and makes intelligent use of screen size.
    #clear
    #echo "Every 3 seconds:  "(date)

    # TODO: show more context, up to full output, if screen size allows?
    #   Makes less sense without clearing.
    # TODO: show full current output + series of "reverse diffs"
    #   (like RCS & SVN storage)?
    # TODO: consider accumulating history in git, for advanced querying?!
    #   (could even feed into https://github.com/pomber/git-history/ ?)
    # TODO: Show deeper history in one view. More +- columns?
    #   Decaying colors by line age?  Longer-lingering deleted lines?
    if cmp --silent $old $new
        sleep 0.2
    else
        tput bold; echo -n === (date -Isec) ===; tput sgr0
        diff -U4 $old $new | delta --paging=never --file-style=omit --hunk-header-decoration-style=''
        #wdiff -n $old $new | colordiff
        mv -f $new $old
        sleep 3

        # TODO: after a lot of chronological small changes, it becomes hard to see what full current output looks like.
        #  PLain `watch` is better in that respect!  This was an attempt to revert to that when "quiet", but looks confusing.
        #head -n $LINES $old
        #  Perhaps show diff but with higher --context?  How to tune for output longer than $LINES??
    end
end
cleanup
